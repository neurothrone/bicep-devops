trigger: none

name: Deploy Resources to Azure with Bicep using Resource Group scope

parameters:
  - name: vmImageName
    type: string
    default: "ubuntu-latest"

  - name: serviceConnectionName
    type: string
    default: "BicepDevOpsConnection"

  - name: environment
    type: string
    default: "dev"

  - name: deploymentLocation
    type: string
    default: "swedencentral"

  - name: resourceGroupName
    type: string
    default: "rg-bicep-devops"

  - name: useEnvironmentSuffix
    type: boolean
    default: true

variables:
  vmImageName: ${{ parameters.vmImageName }}
  resourceGroupName: ${{ parameters.resourceGroupName }}${{ if eq(parameters.useEnvironmentSuffix, true) }}-${{ parameters.environment }}
  templateFile: $(System.DefaultWorkingDirectory)/infra/deploy-rg-scope/main.bicep
  csmParametersFile: $(System.DefaultWorkingDirectory)/infra/deploy-rg-scope/main.parameters.json

pool:
  vmImage: $(vmImageName)

jobs:
  - job:
    displayName: "Deploy Azure IaC with Bicep"
    steps:
      - task: AzureResourceManagerTemplateDeployment@3
        displayName: "Deploy Bicep Template to Azure"
        inputs:
          deploymentScope: "Resource Group"
          connectedServiceName: ${{ parameters.serviceConnectionName }}
          action: "Create Or Update Resource Group"
          resourceGroupName: $(resourceGroupName)
          location: ${{ parameters.deploymentLocation }}
          templateLocation: "Linked artifact"
          csmFile: $(templateFile)
          csmParametersFile: $(csmParametersFile)
          overrideParameters: >
            -environment ${{ parameters.environment }}
          deploymentName: $(Build.BuildId)
          deploymentMode: "Incremental"
